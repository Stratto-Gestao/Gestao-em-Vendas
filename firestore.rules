rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin role
    function isAdmin() {
      return request.auth.token.admin == true;
    }

    // Helper function to check for SUPER_ADMIN role
    function isSuperAdmin() {
      return request.auth.token.role == 'SUPER_ADMIN';
    }

    // Users Collection
    match /users/{userId} {
      // Admins can do anything. Users can read their own data.
      allow read: if isAdmin() || request.auth.uid == userId;
      allow create: if isAdmin(); // Only admins can create users
      allow update, delete: if isAdmin();
    }
    match /users {
      // Only admins can list all users.
      allow list: if isAdmin();
    }

    // Tarefas Collection - Novas regras específicas
    match /tarefas/{tarefaId} {
      // Authenticated users can read and create their own tasks
      allow read, create: if request.auth.uid != null;
      // Only the owner can update their tasks
      allow update: if request.auth.uid == resource.data.criadoPor || request.auth.uid == resource.data.responsavel;
      // Only SUPER_ADMIN can delete tasks
      allow delete: if isSuperAdmin();
    }
    match /tarefas {
      // Authenticated users can list tasks
      allow list: if request.auth.uid != null;
    }

    // Historico Collection - Para dados históricos das tarefas
    match /historico/{historicoId} {
      // Authenticated users can read and create historical data
      allow read, create: if request.auth.uid != null;
      // Only the owner can update
      allow update: if request.auth.uid == resource.data.criadoPor;
      // Only SUPER_ADMIN can delete historical data
      allow delete: if isSuperAdmin();
    }

    // Modules Collection
    match /modules/{moduleId} {
      // Authenticated users can read modules. Admins can write.
      allow read: if request.auth.uid != null;
      allow write: if isAdmin();
    }
    match /modules {
        // Only admins can list all modules.
        allow list: if isAdmin();
    }

    // Articles Collection
    match /articles/{articleId} {
      // Authenticated users can read articles. Admins can write.
      allow read: if request.auth.uid != null;
      allow write: if isAdmin();
    }
    match /articles {
        // Only admins can list all articles.
        allow list: if isAdmin();
    }

    // Scripts Collection
    match /scripts/{scriptId} {
      // Authenticated users can read scripts. Admins can write.
      allow read: if request.auth.uid != null;
      allow write: if isAdmin();
    }
    match /scripts {
        // Only admins can list all scripts.
        allow list: if isAdmin();
    }

    // Vendas Collection - Para controle de vendas
    match /vendas/{vendaId} {
      // Authenticated users can read/write their own data
      allow read, write: if request.auth != null && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == request.resource.data.userId);
      // Admins can access all sales data
      allow read, write: if isAdmin();
    }

    // Faturamentos Collection - Para controle de faturamentos
    match /faturamentos/{faturamentoId} {
      // Authenticated users can read/write their own data
      allow read, write: if request.auth != null && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == request.resource.data.userId);
      // Admins can access all billing data
      allow read, write: if isAdmin();
    }
  }
}